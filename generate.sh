#!/usr/bin/env bash
cd "$(dirname "$0")"
source ./script/setup.sh

version=$(head -1 ./version.txt | awk '{print $1}')
build_number=$(tail -1 ./version.txt | awk '{print $1}')

cat > Sources/Common/versionGenerated.swift <<EOF
// FILE IS GENERATED BY generate.sh
public let aeroSpaceAppVersion = "$version"
EOF

entries() {
    for file in $(ls docs/aerospace-*.adoc); do
        if grep -q 'exec-and-forget' <<< $file; then
            continue
        fi
        subcommand=$(basename $file | sed 's/^aerospace-//' | sed 's/\.adoc$//')
        desc="$(grep :manpurpose: $file | sed -E 's/:manpurpose: //')"
        echo "    [\"  $subcommand\", \"$desc\"],"
    done
}

cat <<EOF > ./Sources/Cli/subcommandDescriptionsGenerated.swift
// FILE IS GENERATED BY generate.sh
let subcommandDescriptions = [
$(entries)
]
EOF

cat <<EOF > ./Sources/Common/gitHashGenerated.swift
// FILE IS GENERATED BY generate.sh AND AUTO-UPDATED BY build-release.sh
public let gitHash = "SNAPSHOT"
public let gitShortHash = "SNAPSHOT"
EOF

export AEROSPACE_VERSION=$version
export AEROSPACE_BUILD_NUMBER=$build_number
export AEROSPACE_CODE_SIGN_IDENTITY=${AEROSPACE_CODE_SIGN_IDENTITY:-aerospace-codesign-certificate}
xcodegen # https://github.com/yonaskolb/XcodeGen
